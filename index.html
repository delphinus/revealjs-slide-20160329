<!doctype html>
<html>

  <head>
    <meta charset="utf-8">

    <title>TypeScript による今風の JavaScript 開発</title>

    <meta name="description" content="slide for 2016-03-29 MTG">
    <meta name="author" content="delphinus">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/league.css" id="theme">
    <link rel="stylesheet" href="lib/font/source-sans-pro/source-sans-pro.css">

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->

    <style>
      @font-face {
        font-family: Lato;
        src: local(SourceSansPro);
      }
      @font-face {
        font-family: sans-serif;
        src: local(HiraginoSans-W1);
      }
      @font-face {
        font-family: monospace;
        src: local(Ricty);
      }
    </style>
  </head>

  <body>

    <div class="reveal">

      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">
        <section data-markdown>
          <script type="text/template">
            # TypeScript による<br>今風の<br>Web アプリ開発
          </script>
        </section>
        <section data-markdown>
          <script type="text/template">
            ## TypeScript とは……
            * 次世代 JS - ECMAScript2015 の上位互換 + 型
            * Microsoft 製
            * オープンソース
            * 各種エディタのサポートが充実（Vim も！）
          </script>
        </section>
        <section data-markdown>
          <script type="text/template">
            ## ECMAScript2015 で<br>追加された文法
            * Class & Namespace
              ```typescript
              namespace Hoge {
                class Fuga {
                  hofu() {}
                }
              }
              ```
            * Arrow Function `() => {}`
            * Rest Parameters `(a, b, ...args) => {}`
            * Spread Parameters `[a, b, ...hoge]`
            * New Object Literals `{some, more, props}`
            * Template String ``` `[${level}] ${message}` ```
            * その他たくさん！
          </script>
        </section>
        <section data-markdown>
          <script type="text/template">
            ## module loading
            * `some_module.js`
              ```typescript
              export const hoge = "ほげ";
              export function fuga { console.log("ふが"); };
              ```
            * `app.js`
              ```typescript
              import {hoge, fuga} from "./some_module";

              console.log(hoge);
              fuga();
              ```
            * 複数ファイルに分割して開発がやりやすくなった。
          </script>
        </section>:
        <section data-markdown>
          <script type="text/template">
            ## TypeScript は ES2015 + 型
            ```typescript
            let hoge: string = "ほげ";

            // hoge = 1; # => error!

            type LogLevel = "debug" | "info" | "warn" | "error" | "fatal";
            function log(level: LogLevel, message: string) {
              console.log(`[${level}] ${message}`);
            }

            // log("waaarn", "fugafuga"); # => error!
            ```
            * コンパイル時にエラーを見つけてくれる。
            * とかくフリーダムになりがちな JavaScript では凄く助かる。
          </script>
        </section>
        <section data-markdown>
          <script type="text/template">
            # 実践
            * TypeScript を Rails プロジェクトで使ってみた。
          </script>
        </section>
        <section data-markdown>
          <script type="text/template">
            ## 既存ライブラリーは<br>npm で管理
            * jQuery とか underscore.js とかいろいろ使いたいときもある。
            * bower? 何それ (^q^)
            * 大体のライブラリーは [npm][] に登録してあるし、してないものは github から直で入れる。
            * gulp や browserify 等のツールも全部 npm 経由で実行する。
            * `package.json` と `npm-shrinkwrap.json` でバージョン管理。

            [npm]: https://www.npmjs.com
          </script>
        </section>
        <section data-markdown>
          <script type="text/template">
            ## 既存の JS ライブラリと<br>共存する
            * 最初から TypeScript で書いてあるライブラリなんてほとんどない。
            * jQuery プラグインとか使いたい！
            * それ、型定義ファイルでできるよ。
          </script>
        </section>
        <section data-markdown>
          <script type="text/template">
            ## 型定義ファイル
            * 既存のライブラリーが export する関数・変数などについての型情報が書いてある。
            * メジャーなライブラリーについては [DefinitelyTyped][] に揃ってる。
            * メジャーじゃないものは……自分で書くしかない。

            [DefinitelyTyped]: https://github.com/DefinitelyTyped/DefinitelyTyped
          </script>
        </section>
        <section data-markdown>
          <script type="text/template">
            * 書いてみた例
              - [jquery-easy-loading.d.ts][jts]
            * 使用例
              ![使用例](img/loading-example.png)

            [jts]: https://github.com/DefinitelyTyped/DefinitelyTyped/blob/master/jquery-easy-loading/jquery-easy-loading.d.ts
          </script>
        </section>
        <section data-markdown>
          <script type="text/template">
            ## 書いてみた結果……
            * 型定義ファイルを書くためにはライブラリーのソースを読んで理解しないといけない。
              - ドキュメントに返値の型までちゃんと書いてあれば楽なんだけどね……
            * 結構大変だけど書かないと開発始められない。
            * 既存のライブラリーを使いたいときはこのコストとのトレードオフ。
          </script>
        </section>
        <section data-markdown>
          <script type="text/template">
            ## 複数ファイルをまとめる
            * （TypeScript でも）複数ファイルでアプリを構成することはできるが、`<script>` をたくさん書くとパフォーマンス的にアレ。
            * 複数のモジュールを一つにまとめ、場合によっては難読化する。
          </script>
        </section>
        <section data-markdown>
          <script type="text/template">
            ## browserify
            ```sh
            browserify app.ts -p [ tsify ] > script.js
            ```
            * 毎回コマンド打つのは大変なので、普通は gulp で自動化する。
          </script>
        </section>
        <section data-markdown>
          <script type="text/template">
            ## Rails のアセット<br>パイプラインと共存する
            * Sprockets を全部 JavaScript で置き換えてしまった[スゴイ人も居る][sugoi]が、ここまでやるのは大変。
            * 折衷案として、browserify でビルドした一つの JS を `public/assets` に置く。
              - `app/assets/javascripts` は無視
            * パッケージによっては個別の CSS / img が必要なこともある。（bootstrap とか）
              - これらは手でコピーしたりしてアセットパイプラインに載せる。

            [sugoi]: http://waka.github.io/2015/11/25/gulp_sprockets.html
          </script>
        </section>
        <section data-markdown>
          <script type="text/template">
            ## タスクの自動化
            * 定型タスクを自動化する。
              - TypeScript をコンパイル。
              - 複数ファイルをビルドしてまとめる。
              - （必要なら）難読化する。
              - （必要なら）スクリプトを所定の場所に移動する。
              - などなど……
            * gulp がデファクトスタンダード。
              - Grunt? 何それ (^q^)
                - JS 界はこんなんばっかり……
          </script>
        </section>
        <section data-markdown>
          <script type="text/template">
            ## gulp
            * 定型タスクの例
              ```javascript
              gulp.task(
                'eslint',
                () => gulp.src('gulp/**/*.js')
                  .pipe(plumber({errorHandler: handleErrors}))
                  .pipe(eslint())
                  .pipe(eslint.failOnError())
                  .pipe(plumber.stop())
              );
              ```
            * だいぶ秘伝のタレ化してしまった。
            * ES2015 で書いて eslint かけて品質を担保。
          </script>
        </section>
        <section data-markdown>
          <script type="text/template">
            ## フロントエンドの<br>ログを取りたい！
            * 普通の Web アプリなら `console.log()` で十分。
            * でも WebView で表示してるときのログは見れない。
            * production では致命的なバグが起こったときに教えて欲しい。
          </script>
        </section>
        <section data-markdown>
          <script type="text/template">
            ## ログをバックエンドに送るモジュールを書く
            ```typescript
            Logger.fatal = (message: string): JQueryPromise<{}> => {
              const level = "fatal";
              return $.post("/log", {level, message});
            };

            // 他にも Logger.info とか Logger.debug とか……
            ```
            * でもこれだと、どこでログを吐いたのか分からない。  
              (´・ω・｀)
          </script>
        </section>
        <section data-markdown>
          <script type="text/template">
            ## Stacktrace-js
            * https://github.com/stacktracejs/stacktrace.js
            * スタックトレースが取れるスゴイやつ。

              ```typescript
              Logger.fatal = (message: string): Promise<{}> => {
                const level = "fatal";
                return StackTrace.get()
                  .then((stackframes: StackTrace.StackFrame[]) =>
                    Promise.resolve(
                      $.post("/log", {level, message, stackframes})
                    )
                  );
              };

              // 致命的エラーが起きたときだけサーバーに送信
              window.onerror = (message: string) => Logger.fatal(message);
              ```
          </script>
        </section>
        <section data-markdown>
          <script type="text/template">
            # 終わり
            [初めに戻る](#/)
          </script>
        </section>

      </div>

    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        transition: 'slide', // none/fade/slide/convex/concave/zoom

        // Optional reveal.js plugins
        dependencies: [
          { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: 'plugin/zoom-js/zoom.js', async: true },
          { src: 'plugin/notes/notes.js', async: true }
        ]
      });
      Reveal.configure({slideNumber: 'c/t'});

    </script>

  </body>
</html>
